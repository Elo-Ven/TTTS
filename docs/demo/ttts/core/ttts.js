"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,_toPropertyKey(n.key),n)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function _defineProperty(t,e,i){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _toPropertyKey(t){t=_toPrimitive(t,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0===i)return("string"===e?String:Number)(t);i=i.call(t,e||"default");if("object"!==_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}var TwineTextToSpeech=function(){function e(){var t=this;_classCallCheck(this,e),_defineProperty(this,"version","2.4"),_defineProperty(this,"pitch",1),_defineProperty(this,"rate",1),_defineProperty(this,"voice",0),_defineProperty(this,"volume",1),_defineProperty(this,"autoplay",!0),_defineProperty(this,"container","#passages, tw-passage"),_defineProperty(this,"overwriteParams",[]),_defineProperty(this,"position","tr"),_defineProperty(this,"mediaDir","./ttts/media"),_defineProperty(this,"debug",!1),_defineProperty(this,"highlighter",!1),_defineProperty(this,"silence",[".link-internal","tw-link","tw-sidebar","script","table","select","textarea","img","svg","object","iframe",".error-view",".error"]),_defineProperty(this,"trigger",[".link-internal","tw-link"]),_defineProperty(this,"triggerIgnore",[]),_defineProperty(this,"voices",[]),_defineProperty(this,"utter",void 0),_defineProperty(this,"synth",window.speechSynthesis),_defineProperty(this,"htmlBackup",""),_defineProperty(this,"passagesContainer",void 0),_defineProperty(this,"queue",[]),_defineProperty(this,"queueCount",0),_defineProperty(this,"queueCountManual",!1),_defineProperty(this,"rawText",""),_defineProperty(this,"playBtn",void 0),_defineProperty(this,"nextBtn",void 0),_defineProperty(this,"prevBtn",void 0),_defineProperty(this,"configBtn",void 0),_defineProperty(this,"configContainer",void 0),_defineProperty(this,"tttsContainer",void 0),_defineProperty(this,"framework",""),_defineProperty(this,"reset",function(){t.debug&&console.log("TTTS | Reset"),t.synth.cancel(),t.queue=[],t.queueCount=0,t.nextBtn.classList.add("disabled"),t.prevBtn.classList.add("disabled"),t.playBtn.classList.remove("play")})}return _createClass(e,[{key:"init",value:function(){var t=this;console.log("TTTS | Running setup"),this.loadSynth().then(function(){t.importProfile(),t.getParams(),t.initHtml(),t.fetchVoices(),t.initEvents(),t.onLoaded()})}},{key:"importProfile",value:function(){if("undefined"!=typeof tttsProfile){var t,e=[],i=["silence","trigger","triggerIgnore"];for(t in tttsProfile)!i.includes(t)||this.overwriteParams.includes(t)?this[t]=tttsProfile[t]:this[t]=this[t].concat(tttsProfile[t]),e.push(t);0<e.length&&console.log("TTTS | Imported profile with "+e.join(","))}document.querySelector("head").insertAdjacentHTML("beforeend",'<link rel="stylesheet" type="text/css" href="ttts/core/ttts-style.css" />')}},{key:"initHtml",value:function(){var n=this,t='<div id="ttts-config-container"><div id="ttts-config-body"><p id="ttts-title">Twine Screen Reader Settings (v'+this.version+')</p><div id="ttts-controls"><p class="ttts-title-field">Shortcuts</p><ul><li>Play: 0 / Numpad 0</li><li>Next: > (right arrow)</li><li>Back: < (left arrow)</li></ul></div><div id="ttts-autoplay"><p class="ttts-autoplay-field">Autoplay: <button class="ttts-autoplay-btn">'+(this.autoplay?"On":"Off")+'</button></p></div><div id="ttts-volume"><p class="ttts-title-field">Volume: <span class="ttts-config-slider-val">'+this.volume+'</span></p><input data-id="volume" type="range" class="ttts-config-slider" min="0" max="1" step="0.1" value="'+this.volume+'"></div><div id="ttts-rate"><p class="ttts-title-field">Speed: <span class="ttts-config-slider-val">'+this.rate+'</span></p><input data-id="rate" type="range" class="ttts-config-slider" min="0.5" max="3" step="0.1" value="'+this.rate+'"></div><div id="ttts-pitch"><p class="ttts-title-field">Pitch: <span class="ttts-config-slider-val">'+this.pitch+'</span></p><input data-id="pitch" type="range" class="ttts-config-slider" min="0.5" max="3" step="0.1" value="'+this.pitch+'"></div><p class="ttts-title-field">Voice</p><div id="ttts-voices"></div></div></div>',s=document.createElement("div"),e=(s.id="ttts-player",s.classList.add("ttts-player-"+this.position),[{id:"ttts-config",alt:"?",icon:"config.png"},{id:"ttts-prev",disabled:!0,alt:"<",icon:"next.png"},{id:"ttts-next",disabled:!0,alt:">",icon:"next.png"},{id:"ttts-play",alt:"+",icon:"play.png"}]),i=(e.map(function(t){var e=document.createElement("div"),i=(e.id=t.id,t.disabled&&e.classList.add("disabled"),document.createElement("span")),i=(i.textContent=t.alt,e.appendChild(i),document.createElement("img"));i.src=n.mediaDir+"/"+t.icon,i.classList.add(t.id+"-sprite"),e.appendChild(i),"ttts-play"===t.id&&((i=document.createElement("img")).src=n.mediaDir+"/pause.png",i.classList.add("ttts-pause-sprite"),e.appendChild(i)),s.appendChild(e)}),document.createElement("div"));i.id="ttts",i.classList.add("ttts-enable"),i.insertAdjacentHTML("beforeend",t),i.appendChild(s),document.querySelector("body").appendChild(i),e.map(function(t){n.checkImage(n.mediaDir+"/"+t.icon,function(){document.querySelector("#"+t.id+" span").remove()},function(){document.querySelector("#"+t.id+" img").remove()})}),this.tttsContainer=document.querySelector("#ttts"),this.playBtn=document.querySelector("#ttts-play"),this.nextBtn=document.querySelector("#ttts-next"),this.prevBtn=document.querySelector("#ttts-prev"),this.configBtn=document.querySelector("#ttts-config"),this.configContainer=document.querySelector("#ttts-config-container")}},{key:"initEvents",value:function(){var i=this;this.playBtn.addEventListener("click",function(t){i.synth.speaking?i.reset():i.onPlay()}),this.nextBtn.addEventListener("click",function(t){t.target.classList.contains("disabled")||i.onNext()}),this.prevBtn.addEventListener("click",function(t){t.target.classList.contains("disabled")||i.onPrev()}),this.configBtn.addEventListener("click",function(t){i.configContainer.classList.contains("open")?i.configContainer.classList.remove("open"):i.configContainer.classList.add("open")}),this.configContainer.addEventListener("click",function(t){var e;t.target.classList.contains("ttts-autoplay-btn")?(i.autoplay=!i.autoplay,i.saveParam("autoplay",i.autoplay),i.autoplay?t.target.innerHTML="On":t.target.innerHTML="Off"):t.target.classList.contains("ttts-highlighter-btn")?(i.highlighter=!i.highlighter,i.saveParam("highlighter",i.highlighter),i.highlighter?t.target.innerHTML="On":t.target.innerHTML="Off"):t.target.classList.contains("ttts-voice-sample")?(i.synth.cancel(),i.speak({text:"The quick brown fox jumps over the lazy dog.",voice:t.target.closest(".ttts-voice").dataset.id})):t.target.classList.contains("ttts-voice-select")?(i.synth.cancel(),e=t.target.closest(".ttts-voice"),i.saveParam("voice",e.dataset.id),document.querySelectorAll(".ttts-active").forEach(function(t){return t.classList.remove("ttts-active")}),e.classList.add("ttts-active")):t.target==i.configContainer&&i.configContainer.classList.remove("open")}),this.configContainer.querySelectorAll(".ttts-config-slider").forEach(function(t){return t.addEventListener("change",function(t){var e=t.target.dataset.id;void 0!==i[e]&&(i[e]=t.target.value,i.saveParam(e,t.target.value),i.configContainer.querySelector("#ttts-"+e+" .ttts-config-slider-val").innerText=t.target.value)})}),document.addEventListener("keydown",function(t){96==t.which||48==t.which?i.synth.speaking?i.reset():i.onPlay():37==t.which?i.onPrev():39==t.which&&i.onNext()}),window.addEventListener("ttts-enable",function(t){i.tttsContainer.classList.add("ttts-enable")}),window.addEventListener("ttts-disable",function(t){i.tttsContainer.classList.remove("ttts-enable"),i.reset()}),window.addEventListener("unload",function(t){i.reset()})}},{key:"checkImage",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],n=new Image;!1===e&&(e=function(){}),!1!==i&&(n.onerror=i),n.onload=e,n.src=t}},{key:"loadSynth",value:function(){return new Promise(function(t,e){var i=window.speechSynthesis,n=setInterval(function(){0<i.getVoices().length&&(t(),clearInterval(n))},10)})}},{key:"getPassages",value:function(){var t=this;this.passagesContainer=document.querySelector(this.container),this.passagesContainer&&"1"!==this.passagesContainer.getAttribute("listening")&&(this.passagesContainer.setAttribute("listening","1"),this.passagesContainer.addEventListener("mouseup",function(e){var i=!1;if(!t.autoplay)return!1;t.trigger.map(function(t){!i&&e.target.closest(t)&&(i=!0)}),t.triggerIgnore.map(function(t){i&&e.target.closest(t)&&(i=!1)}),i&&t.onPlay()}))}},{key:"getParam",value:function(t){var e=localStorage.getItem("ttts-"+t);if(null!=e){switch(t){case"autoplay":case"highlighter":e="true"===e;break;case"voice":e=parseInt(e);break;case"rate":case"pitch":case"volume":e=parseFloat(e)}this[t]=e}}},{key:"getParams",value:function(){var e=this;["voice","rate","pitch","volume","autoplay","highlighter"].map(function(t){e.getParam(t)})}},{key:"fetchVoices",value:function(){var r=this;if(0<this.voices.length)return!1;this.voices=this.synth.getVoices(),this.debug&&(console.log("TTTS | VOICE | ",this.voice),console.log("TTTS | VOICES | ",this.voices)),0<this.voices.length&&this.voices.map(function(t,e){var i=document.createElement("div"),n=(i.classList.add("ttts-voice"),i.dataset.id=e,document.createElement("p")),s=(n.classList.add("ttts-voice-title"),n.innerText=parseInt(e)+": "+r.voices[e].name,document.createElement("button")),a=(s.classList.add("ttts-voice-sample"),s.innerText="Sample",document.createElement("button"));a.classList.add("ttts-voice-select"),a.innerText="Select",i.appendChild(n),i.appendChild(s),i.appendChild(a),parseInt(e)===parseInt(r.voice)&&i.classList.add("ttts-active"),document.querySelector("#ttts-voices").appendChild(i)})}},{key:"onLoaded",value:function(){var e=this;setTimeout(function(){var t;e.getPassages(),e.passagesContainer?(void 0!==document.querySelector("#story > #passages")?e.framework="sugarcube":void 0!==document.querySelector("tw-story > tw-passage")&&(e.framework="harlowe"),console.log("TTTS | Setup complete"),t=new CustomEvent("ttts-onloaded",{ttts:e}),window.dispatchEvent(t)):e.onLoaded()},500)}},{key:"onNext",value:function(){this.debug&&console.log("TTTS | Next"),this.synth.cancel(),this.queueCount++,this.run()}},{key:"onPlay",value:function(){var t=this;(this.synth.speaking||this.playBtn.classList.contains("play"))&&this.reset(),setTimeout(function(){t.debug&&console.log("TTTS | Run"),t.processPassages(),t.run()},500)}},{key:"processPassages",value:function(){var i=this,e=(this.getPassages(),document.createElement("div")),n=(e.innerHTML=this.passagesContainer.innerHTML,this.silence.map(function(t){e.querySelectorAll(t).forEach(function(t){return t.remove()})}),e.innerHTML=e.innerHTML.replaceAll("<br>","\n"),e.innerHTML=e.innerHTML.replaceAll("<br/>","\n"),e.innerHTML=e.innerHTML.replaceAll(/\n\s*\n/g,"\n"),e.innerHTML=e.innerHTML.replaceAll(/\t/g," "),e.innerHTML=e.innerHTML.replaceAll(/ +(?= )/g," "),[]),t=e.innerHTML.trim().match(/[^\r\n]+/g);this.debug&&console.log("TTTS | LINES | ",t),null!==t&&0<t.length&&t.map(function(t){var e=document.createElement("div"),e=(e.innerHTML=t,e.innerText);""===(e=(e=(e=e.replaceAll("..",".")).replaceAll(",,",",")).trim())||n.includes(e)||(n.push(e),i.queue.push({text:e,pitch:i.pitch,voice:i.voice,orig:t}))})}},{key:"onPrev",value:function(){this.debug&&console.log("TTTS | Prev"),this.synth.cancel(),this.queueCount--,this.run()}},{key:"run",value:function(){if(!this.tttsContainer.classList.contains("ttts-enable"))return!1;0===this.queueCount?this.prevBtn.classList.add("disabled"):this.prevBtn.classList.remove("disabled"),this.queueCount+1>=this.queue.length?this.nextBtn.classList.add("disabled"):this.nextBtn.classList.remove("disabled"),void 0!==this.queue[this.queueCount]?this.speak(this.queue[this.queueCount]):this.reset()}},{key:"saveParam",value:function(t,e){localStorage.setItem("ttts-"+t,e),this.getParam(t)}},{key:"speak",value:function(t){this.utter=new SpeechSynthesisUtterance,this.utter.rate=this.rate,this.utter.volume=this.volume,this.utter.voice=this.voices[t.voice],this.utter.text=t.text,this.utter.pitch=this.pitch;var e=this;this.utter.onstart=function(t){e.playBtn.classList.add("play")},this.utter.onend=function(t){e.playBtn.classList.remove("play"),e.queueCountManual||e.queueCount++,e.queueCountManual=!1,e.run()},this.utter.onpause=function(t){e.queueCountManual=!0,e.synth.cancel()},this.debug&&console.log("TTTS | SPEAK | "+t.text),this.synth.speak(this.utter)}}]),e}();;

if ('speechSynthesis' in window) {
    //attempt to import the game profile
    const profile = document.createElement('script');
    profile.src = 'ttts/ttts-profile.js';
    profile.type = 'text/javascript';
    document.querySelector('head').appendChild(profile);

    //wait for the page to load and move to the end of the render queue before init
    const ttts = new TwineTextToSpeech();
    window.onload = function () {
        setTimeout(() => {
            ttts.init();
        }, 1);
    };
} else {
    console.log('TTTS | Failed to load, speechSynthesis is not available in your browser');
}
