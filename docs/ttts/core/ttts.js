class TwineTextToSpeech{version="2.3";pitch=1;rate=1;voice=0;volume=1;autoplay=!0;container="#passages, tw-passage";overwriteParams=[];debug=!1;highlighter=!1;silence=[".link-internal","tw-link","tw-sidebar","script","table","select","textarea","img","svg","object","iframe",".error-view",".error"];trigger=[".link-internal","tw-link"];triggerIgnore=[];voices=[];utter;synth=window.speechSynthesis;htmlBackup="";passagesContainer;queue=[];queueCount=0;queueCountManual=!1;rawText="";playBtn;nextBtn;prevBtn;configBtn;configContainer;tttsContainer;framework="";init(){console.log("TTTS | Running setup"),this.loadSynth().then(()=>{this.importProfile(),this.getParams(),this.initHtml(),this.fetchVoices(),this.initEvents(),this.onLoaded()})}importProfile(){if("undefined"!=typeof tttsProfile){var t=[],e=["silence","trigger","triggerIgnore"];for(const s in tttsProfile)!e.includes(s)||this.overwriteParams.includes(s)?this[s]=tttsProfile[s]:this[s]=this[s].concat(tttsProfile[s]),t.push(s);0<t.length&&console.log("TTTS | Imported profile with "+t.join(","))}document.querySelector("head").insertAdjacentHTML("beforeend",'<link rel="stylesheet" type="text/css" href="ttts/core/ttts-style.css" />')}initHtml(){var t='<div id="ttts-config-container"><div id="ttts-config-body"><p id="ttts-title">Twine Screen Reader Settings (v'+this.version+')</p><div id="ttts-controls"><p class="ttts-title-field">Shortcuts</p><ul><li>Play: 0 / Numpad 0</li><li>Next: > (right arrow)</li><li>Back: < (left arrow)</li></ul></div><div id="ttts-autoplay"><p class="ttts-autoplay-field">Autoplay: <button class="ttts-autoplay-btn">'+(this.autoplay?"On":"Off")+'</button></p></div><div id="ttts-volume"><p class="ttts-title-field">Volume: <span class="ttts-config-slider-val">'+this.volume+'</span></p><input data-id="volume" type="range" class="ttts-config-slider" min="0" max="1" step="0.1" value="'+this.volume+'"></div><div id="ttts-rate"><p class="ttts-title-field">Speed: <span class="ttts-config-slider-val">'+this.rate+'</span></p><input data-id="rate" type="range" class="ttts-config-slider" min="0.5" max="3" step="0.1" value="'+this.rate+'"></div><div id="ttts-pitch"><p class="ttts-title-field">Pitch: <span class="ttts-config-slider-val">'+this.pitch+'</span></p><input data-id="pitch" type="range" class="ttts-config-slider" min="0.5" max="3" step="0.1" value="'+this.pitch+'"></div><p class="ttts-title-field">Voice</p><div id="ttts-voices"></div></div></div>';const s=document.createElement("div");s.id="ttts-player";[{id:"ttts-config"},{id:"ttts-prev",disabled:!0},{id:"ttts-next",disabled:!0},{id:"ttts-play"}].map(t=>{var e=document.createElement("div");e.id=t.id,t.disabled&&e.classList.add("disabled"),s.appendChild(e)});var e=document.createElement("div");e.id="ttts",e.classList.add("ttts-enable"),e.insertAdjacentHTML("beforeend",t),e.appendChild(s),document.querySelector("body").appendChild(e),this.tttsContainer=document.querySelector("#ttts"),this.playBtn=document.querySelector("#ttts-play"),this.nextBtn=document.querySelector("#ttts-next"),this.prevBtn=document.querySelector("#ttts-prev"),this.configBtn=document.querySelector("#ttts-config"),this.configContainer=document.querySelector("#ttts-config-container")}initEvents(){this.playBtn.addEventListener("click",t=>{this.synth.speaking?this.reset():this.onPlay()}),this.nextBtn.addEventListener("click",t=>{t.target.classList.contains("disabled")||this.onNext()}),this.prevBtn.addEventListener("click",t=>{t.target.classList.contains("disabled")||this.onPrev()}),this.configBtn.addEventListener("click",t=>{this.configContainer.classList.contains("open")?this.configContainer.classList.remove("open"):this.configContainer.classList.add("open")}),this.configContainer.addEventListener("click",t=>{var e;t.target.classList.contains("ttts-autoplay-btn")?(this.autoplay=!this.autoplay,this.saveParam("autoplay",this.autoplay),this.autoplay?t.target.innerHTML="On":t.target.innerHTML="Off"):t.target.classList.contains("ttts-highlighter-btn")?(this.highlighter=!this.highlighter,this.saveParam("highlighter",this.highlighter),this.highlighter?t.target.innerHTML="On":t.target.innerHTML="Off"):t.target.classList.contains("ttts-voice-sample")?(this.synth.cancel(),this.speak({text:"The quick brown fox jumps over the lazy dog.",voice:t.target.closest(".ttts-voice").dataset.id})):t.target.classList.contains("ttts-voice-select")?(this.synth.cancel(),e=t.target.closest(".ttts-voice"),this.saveParam("voice",e.dataset.id),document.querySelectorAll(".ttts-active").forEach(t=>t.classList.remove("ttts-active")),e.classList.add("ttts-active")):t.target==this.configContainer&&this.configContainer.classList.remove("open")}),this.configContainer.querySelectorAll(".ttts-config-slider").forEach(t=>t.addEventListener("change",t=>{var e=t.target.dataset.id;void 0!==this[e]&&(this[e]=t.target.value,this.saveParam(e,t.target.value),this.configContainer.querySelector("#ttts-"+e+" .ttts-config-slider-val").innerText=t.target.value)})),document.addEventListener("keydown",t=>{96==t.which||48==t.which?this.synth.speaking?this.reset():this.onPlay():37==t.which?this.onPrev():39==t.which&&this.onNext()}),window.addEventListener("ttts-enable",t=>{this.tttsContainer.classList.add("ttts-enable")}),window.addEventListener("ttts-disable",t=>{this.tttsContainer.classList.remove("ttts-enable"),this.reset()}),window.addEventListener("unload",t=>{this.reset()})}loadSynth(){return new Promise(function(t,e){let s=window.speechSynthesis,i;i=setInterval(()=>{0<s.getVoices().length&&(t(),clearInterval(i))},10)})}getPassages(){this.passagesContainer=document.querySelector(this.container),this.passagesContainer&&"1"!==this.passagesContainer.getAttribute("listening")&&(this.passagesContainer.setAttribute("listening","1"),this.passagesContainer.addEventListener("mouseup",e=>{let s=!1;if(!this.autoplay)return!1;this.trigger.map(t=>{!s&&e.target.closest(t)&&(s=!0)}),this.triggerIgnore.map(t=>{s&&e.target.closest(t)&&(s=!1)}),s&&this.onPlay()}))}getParam(t){var e=localStorage.getItem("ttts-"+t);if(null!=e){switch(t){case"autoplay":case"highlighter":e="true"===e;break;case"voice":e=parseInt(e);break;case"rate":case"pitch":case"volume":e=parseFloat(e)}this[t]=e}}getParams(){["voice","rate","pitch","volume","autoplay","highlighter"].map(t=>{this.getParam(t)})}fetchVoices(){if(0<this.voices.length)return!1;this.voices=this.synth.getVoices(),this.debug&&(console.log("TTTS | VOICE | ",this.voice),console.log("TTTS | VOICES | ",this.voices)),0<this.voices.length&&this.voices.map((t,e)=>{var s=document.createElement("div"),i=(s.classList.add("ttts-voice"),s.dataset.id=e,document.createElement("p")),n=(i.classList.add("ttts-voice-title"),i.innerText=parseInt(e)+": "+this.voices[e].name,document.createElement("button")),a=(n.classList.add("ttts-voice-sample"),n.innerText="Sample",document.createElement("button"));a.classList.add("ttts-voice-select"),a.innerText="Select",s.appendChild(i),s.appendChild(n),s.appendChild(a),parseInt(e)===parseInt(this.voice)&&s.classList.add("ttts-active"),document.querySelector("#ttts-voices").appendChild(s)})}onLoaded(){setTimeout(()=>{var t;this.getPassages(),this.passagesContainer?(void 0!==document.querySelector("#story > #passages")?this.framework="sugarcube":void 0!==document.querySelector("tw-story > tw-passage")&&(this.framework="harlowe"),console.log("TTTS | Setup complete"),t=new CustomEvent("ttts-onloaded",{ttts:this}),window.dispatchEvent(t)):this.onLoaded()},500)}onNext(){this.debug&&console.log("TTTS | Next"),this.synth.cancel(),this.queueCount++,this.run()}onPlay(){(this.synth.speaking||this.playBtn.classList.contains("play"))&&this.reset(),setTimeout(()=>{this.debug&&console.log("TTTS | Run"),this.processPassages(),this.run()},500)}processPassages(){this.getPassages();const e=document.createElement("div"),i=(e.innerHTML=this.passagesContainer.innerHTML,this.silence.map(t=>{e.querySelectorAll(t).forEach(t=>t.remove())}),e.innerHTML=e.innerHTML.replaceAll("<br>","\n"),e.innerHTML=e.innerHTML.replaceAll("<br/>","\n"),e.innerHTML=e.innerHTML.replaceAll(/\n\s*\n/g,"\n"),e.innerHTML=e.innerHTML.replaceAll(/\t/g," "),e.innerHTML=e.innerHTML.replaceAll(/ +(?= )/g," "),[]);var t=e.innerHTML.trim().match(/[^\r\n]+/g);this.debug&&console.log("TTTS | LINES | ",t),null!==t&&0<t.length&&t.map(t=>{var e=document.createElement("div");e.innerHTML=t;let s=e.innerText;""===(s=(s=(s=s.replaceAll("..",".")).replaceAll(",,",",")).trim())||i.includes(s)||(i.push(s),this.queue.push({text:s,pitch:this.pitch,voice:this.voice,orig:t}))})}onPrev(){this.debug&&console.log("TTTS | Prev"),this.synth.cancel(),this.queueCount--,this.run()}run(){if(!this.tttsContainer.classList.contains("ttts-enable"))return!1;0===this.queueCount?this.prevBtn.classList.add("disabled"):this.prevBtn.classList.remove("disabled"),this.queueCount+1>=this.queue.length?this.nextBtn.classList.add("disabled"):this.nextBtn.classList.remove("disabled"),void 0!==this.queue[this.queueCount]?this.speak(this.queue[this.queueCount]):this.reset()}reset=()=>{this.debug&&console.log("TTTS | Reset"),this.synth.cancel(),this.queue=[],this.queueCount=0,this.nextBtn.classList.add("disabled"),this.prevBtn.classList.add("disabled"),this.playBtn.classList.remove("play")};saveParam(t,e){localStorage.setItem("ttts-"+t,e),this.getParam(t)}speak(t){this.utter=new SpeechSynthesisUtterance,this.utter.rate=this.rate,this.utter.volume=this.volume,this.utter.voice=this.voices[t.voice],this.utter.text=t.text,this.utter.pitch=this.pitch;const e=this;this.utter.onstart=function(t){e.playBtn.classList.add("play")},this.utter.onend=function(t){e.playBtn.classList.remove("play"),e.queueCountManual||e.queueCount++,e.queueCountManual=!1,e.run()},this.utter.onpause=function(t){e.queueCountManual=!0,e.synth.cancel()},this.debug&&console.log("TTTS | SPEAK | "+t.text),this.synth.speak(this.utter)}applyHighlight(t){document.querySelectorAll(".ttts-highlight").forEach(t=>t.classList.remove("ttts-highlight"));let e=this.passagesContainer.innerHTML;var s=document.createElement("ttts");s.className="ttts-highlight",s.innerHTML=t,e=e.replaceAll(t,s.outerHTML),this.passagesContainer.innerHTML=e}}if("speechSynthesis"in window){const ia=document.createElement("script"),ja=(ia.src="ttts/ttts-profile.js",ia.type="text/javascript",document.querySelector("head").appendChild(ia),new TwineTextToSpeech);window.onload=function(){setTimeout(()=>{ja.init()},1)}}else console.log("TTTS | Failed to load, speechSynthesis is not available in your browser");